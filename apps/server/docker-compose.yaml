# Production Docker Compose for API template
# Database server runs separately in the cloud

services:
  # API Service
  api:
    build:
      context: ../..
      dockerfile: apps/server/Dockerfile
      target: production
    
    image: api-template:latest
    container_name: api-template
    
    restart: unless-stopped
    
    ports:
      - "${PORT:-3001}:${PORT:-3001}"
    
    environment:
      # Application Environment
      NODE_ENV: production
      
      # Database Configuration (Cloud/External)
      DATABASE_URL: ${DATABASE_URL}
      
      # Security Configuration
      CORS_ORIGIN: ${CORS_ORIGIN:-*}
      CORS_METHODS: ${CORS_METHODS:-GET,POST,PUT,DELETE,OPTIONS}
      CORS_HEADERS: ${CORS_HEADERS:-Content-Type,Authorization}
      
      # Rate Limiting
      RATE_LIMIT_WINDOW_MS: ${RATE_LIMIT_WINDOW_MS:-900000}
      RATE_LIMIT_MAX: ${RATE_LIMIT_MAX:-100}
      
      # Logging Configuration
      LOG_LEVEL: ${LOG_LEVEL:-info}
    
    # Health check configuration (using Node.js)
    healthcheck:
      test: ["CMD", "sh", "-c", "node -e \"require('http').get('http://localhost:' + (process.env.PORT || 3001) + '/health', (res) => { process.exit(res.statusCode === 200 ? 0 : 1) }).on('error', () => process.exit(1))\""]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    
    # Resource limits for production
    deploy:
      resources:
        limits:
          memory: 1G
          cpus: '1.0'
        reservations:
          memory: 512M
          cpus: '0.5'
    
    # Security configuration
    security_opt:
      - no-new-privileges:true
    
    # Read-only root filesystem for security
    read_only: true
    
    # Temporary filesystems for writable directories
    tmpfs:
      - /tmp:size=100M,noexec,nosuid,nodev
    
    # Logging configuration
    logging:
      driver: json-file
      options:
        max-size: "10m"
        max-file: "3"
        compress: "true"

# Networks configuration
networks:
  default:
    driver: bridge
    name: api-template-network
